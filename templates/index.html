<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF Malware Detector</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <style>
      #metadata-table-body {
        display: none;
      }
      .serif {
        font-family: "Times New Roman", Times, serif;
      }
    </style>
  </head>
  <body>
    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
      <div
        id="prediction-toast"
        class="toast bg-primary text-white"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="toast-header">
          <strong class="me-auto">Prediction Success</strong>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
        <div class="toast-body">Your prediction was successful!</div>
      </div>
    </div>

    {% include 'navbar.html' %}

    <div class="container mx-auto" style="margin-top: 10vh" id="main-container">
      <h1 class="mb-4 serif">PDF-Malware Detector V2</h1>
      <form
        action="/predict"
        method="POST"
        enctype="multipart/form-data"
        id="upload-form"
      >
        <div class="row d-flex flex-column">
          <div class="col-12 col-md-8">
            <div class="input-group">
              <input
                type="file"
                class="form-control mb-4"
                name="pdf_file"
                id="pdf_file"
                accept=".pdf"
              />
            </div>
          </div>
          <div class="col-12 col-md-4 mt-3 mt-md-0">
            <button type="submit" class="btn btn-danger w-100">
              Upload, Extract Metadata, and Predict
            </button>
          </div>
        </div>
      </form>
      <div id="result-detection" class="mt-5"></div>
      <div id="result-container" class="mt-5"></div>
    </div>

    <footer class="footer text-center py-3">
      <span class="text-muted">Â© 2023 PDF Metadata Extractor</span>
    </footer>

    <script>
      document
        .querySelector("#upload-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();

          // Clear previous results
          document.querySelector("#result-detection").innerHTML = "";
          document.querySelector("#result-container").innerHTML = "";

          // Display loading spinner
          const loadingSpinner = document.createElement("div");
          loadingSpinner.className = "spinner-border text-primary";
          loadingSpinner.setAttribute("role", "status");
          const spinnerContainer = document.createElement("div");
          spinnerContainer.appendChild(loadingSpinner);
          spinnerContainer.className = "text-center";
          document
            .querySelector("#main-container")
            .appendChild(spinnerContainer);

          const formData = new FormData(event.target);
          try {
            const response = await fetch("/predict", {
              method: "POST",
              body: formData,
            });
            const data = await response.json();

            // Remove loading spinner when done
            spinnerContainer.remove();

            // Display detection result
            const resultDetection = document.querySelector("#result-detection");
            const detectionResult =
              data.result === "Benign" ? "Benign" : "Malicious";
            const colorClass =
              data.result === "Benign" ? "text-primary" : "text-danger";
            resultDetection.innerHTML = `<h2 class="mt-4">Detection Result</h2><h3 class="${colorClass}">${detectionResult}</h3>`;

            // Display metadata result
            const resultContainer = document.querySelector("#result-container");
            resultContainer.innerHTML = '<h2 class="mt-4">Metadata Result</h2>';

            const metadataTable = document.createElement("table");
            metadataTable.className =
              "table table-bordered table-striped table-hover";

            const metadataTableHead = document.createElement("thead");
            metadataTableHead.className = "table-primary";
            const headerRow = document.createElement("tr");
            const keyHeader = document.createElement("th");
            keyHeader.textContent = "Key";
            const valueHeader = document.createElement("th");
            valueHeader.textContent = "Value";
            headerRow.appendChild(keyHeader);
            headerRow.appendChild(valueHeader);
            metadataTableHead.appendChild(headerRow);
            metadataTable.appendChild(metadataTableHead);

            const metadataTableBody = document.createElement("tbody");
            metadataTable.appendChild(metadataTableBody);

            // Define the order of keys as per your JSON
            const keysOrder = [
              "PDFIDVersion",
              "FileName",
              "Header",
              "Obj",
              "Endobj",
              "Stream",
              "Endstream",
              "Xref",
              "Trailer",
              "StartXref",
              "PageNo",
              "Encrypt",
              "ObjStm",
              "JS",
              "Javascript",
              "AA",
              "OpenAction",
              "Acroform",
              "JBIG2Decode",
              "RichMedia",
              "Launch",
              "EmbeddedFile",
              "XFA",
              "URI",
              "Colors",
            ];

            // Loop through keys in the defined order
            keysOrder.forEach((key) => {
              const row = document.createElement("tr");
              const keyCell = document.createElement("td");
              keyCell.textContent = key;
              const valueCell = document.createElement("td");
              valueCell.textContent = data.metadata[key];
              row.appendChild(keyCell);
              row.appendChild(valueCell);
              metadataTableBody.appendChild(row);
            });

            resultContainer.appendChild(metadataTable);

            // Display toast
            const predictionToast = new bootstrap.Toast(
              document.getElementById("prediction-toast")
            );
            predictionToast.show();
          } catch (error) {
            // Handle errors
            console.error("Error during prediction:", error);

            // Remove loading spinner in case of error
            spinnerContainer.remove();
          }
        });
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
      integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
